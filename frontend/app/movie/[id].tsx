import { useMemo } from 'react';
import { BlurView } from 'expo-blur';
import { Image } from 'expo-image';
import { useLocalSearchParams, useRouter } from 'expo-router';
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import * as Haptics from 'expo-haptics';
import { Pressable, ScrollView, StyleSheet, View } from 'react-native';

import { fetchMovieConfig, getMovieDetails } from '@/api/tmdb';
import { addToWatchlist, getWatchlist, removeFromWatchlist } from '@/api/watchlist';
import ParallaxScrollView from '@/components/parallax-scroll-view';
import { ThemedText } from '@/components/themed-text';
import { ThemedView } from '@/components/themed-view';
import { IconSymbol } from '@/components/ui/icon-symbol';
import { CreateWatchListItemRequest } from '@/constants/types';

const buildImageUrl = (baseUrl: string | null, size: string, path?: string | null) => {
  if (!baseUrl || !path) return null;
  return `${baseUrl}${size}${path}`;
};

export default function MovieDetailsScreen() {
  const router = useRouter();
  const { id } = useLocalSearchParams();
  const movieId = Number(Array.isArray(id) ? id[0] : id);
  const queryClient = useQueryClient();

  const configQuery = useQuery({
    queryKey: ['tmdb-config'],
    queryFn: fetchMovieConfig,
  });

  const detailsQuery = useQuery({
    queryKey: ['movie-details', movieId],
    queryFn: () => getMovieDetails(movieId),
    enabled: Number.isFinite(movieId) && movieId > 0,
  });

  const watchlistQuery = useQuery({
    queryKey: ['watchlist'],
    queryFn: getWatchlist,
  });

  const addMutation = useMutation({
    mutationFn: addToWatchlist,
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ['watchlist'] });
      void Haptics.selectionAsync();
    },
  });

  const removeMutation = useMutation({
    mutationFn: removeFromWatchlist,
    onSuccess: async () => {
      await queryClient.invalidateQueries({ queryKey: ['watchlist'] });
      void Haptics.selectionAsync();
    },
  });

  const baseUrl = configQuery.data?.images?.secure_base_url ?? null;
  const details = detailsQuery.data?.details ?? null;
  const posterUrl = buildImageUrl(baseUrl, 'w780', details?.poster_path);

  const releaseYear = details?.release_date ? details.release_date.slice(0, 4) : null;

  const isInWatchlist = Boolean(
    watchlistQuery.data?.some((item) => item.tmdbId === movieId),
  );

  const handleToggleWatchlist = () => {
    if (!details) return;
    if (isInWatchlist) {
      removeMutation.mutate(movieId);
      return;
    }

    const payload: CreateWatchListItemRequest = {
      tmdbId: movieId,
      title: details.title ?? 'Untitled',
      type: 'movie',
      posterPath: details.poster_path ?? null,
      releaseYear: releaseYear ? Number(releaseYear) : null,
    };

    addMutation.mutate(payload);
  };

  const providers = useMemo(() => {
    const regionMap = detailsQuery.data?.providers?.results ?? {};
    return regionMap.US ?? Object.values(regionMap)[0] ?? null;
  }, [detailsQuery.data?.providers?.results]);

  const cast = details?.credits?.cast?.slice(0, 15) ?? [];
  const crew = details?.credits?.crew ?? [];
  const directors = crew.filter(c => c.job === 'Director');
  const writers = crew.filter(c => c.job === 'Screenplay' || c.job === 'Writer' || c.department === 'Writing');

  return (
    <ParallaxScrollView
      headerBackgroundColor={{ light: '#111111', dark: '#0F0F0F' }}
      headerImage={
        posterUrl ? (
          <View style={styles.headerImageContainer}>
            <Image source={{ uri: posterUrl }} style={styles.heroImage} contentFit="cover" />
            <BlurView intensity={80} tint="dark" style={StyleSheet.absoluteFill} />
          </View>
        ) : (
          <View style={styles.heroPlaceholder} />
        )
      }>


      <View style={styles.contentContainer}>
        <View style={styles.heroRow}>
          <Image
            source={{ uri: posterUrl ?? undefined }}
            style={styles.posterImage}
            contentFit="cover"
            transition={300}
          />
          <View style={styles.heroInfo}>
            <ThemedText type="title" style={styles.titleText}>
              {details?.title ?? 'Loading...'}
            </ThemedText>

            <ThemedText style={styles.subtitleText}>
              {releaseYear
                ? `${releaseYear} Â· ${details?.runtime ? `${details.runtime} min` : 'Runtime n/a'}`
                : 'Runtime unavailable'}
            </ThemedText>

            <View style={styles.actionRow}>
              <Pressable
                onPress={handleToggleWatchlist}
                style={[styles.fab, isInWatchlist ? styles.fabActive : null]}>
                <IconSymbol
                  size={20}
                  name={isInWatchlist ? 'checkmark' : 'plus'}
                  color={isInWatchlist ? '#111111' : '#EDEDED'}
                />
              </Pressable>
              {/* Optional: Add more buttons here later */}
            </View>
          </View>
        </View>

        {details?.tagline ? (
          <ThemedText style={styles.tagline}>{details.tagline}</ThemedText>
        ) : null}

        {details?.overview ? (
          <ThemedText style={styles.overview}>{details.overview}</ThemedText>
        ) : null}

        {/* Top Billing / Key Crew */}
        {directors.length > 0 && (
          <View style={styles.metaRow}>
            <ThemedText style={styles.metaLabel}>Director:</ThemedText>
            <ThemedText style={styles.metaValue}>{directors.map(d => d.name).join(', ')}</ThemedText>
          </View>
        )}
        {writers.length > 0 && (
          <View style={styles.metaRow}>
            <ThemedText style={styles.metaLabel}>Writers:</ThemedText>
            <ThemedText style={styles.metaValue}>{writers.slice(0, 3).map(d => d.name).join(', ')}</ThemedText>
          </View>
        )}

        {/* Cast Section */}
        {cast.length > 0 && (
          <View style={styles.sectionContainer}>
            <ThemedText type="subtitle" style={styles.sectionTitle}>Top Cast</ThemedText>
            <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={styles.castScroll}>
              {cast.map((member) => (
                <View key={member.id} style={styles.castCard}>
                  <Image
                    source={{ uri: buildImageUrl(baseUrl, 'w185', member.profile_path) ?? undefined }}
                    style={styles.castImage}
                    contentFit="cover"
                  />
                  <ThemedText numberOfLines={1} style={styles.castName}>{member.name}</ThemedText>
                  <ThemedText numberOfLines={1} style={styles.castCharacter}>{member.character}</ThemedText>
                </View>
              ))}
            </ScrollView>
          </View>
        )}

        {providers ? (
          <ThemedView style={styles.providersSection}>
            <ThemedText type="subtitle" style={styles.providersTitle}>
              Where to Watch
            </ThemedText>
            <View style={styles.providerRow}>
              {(providers.flatrate ?? []).slice(0, 6).map((provider) => {
                const logoUrl = buildImageUrl(baseUrl, 'w154', provider.logo_path);
                if (!logoUrl) return null;
                return (
                  <Image
                    key={provider.provider_id}
                    source={{ uri: logoUrl }}
                    style={styles.providerLogo}
                    contentFit="cover"
                    transition={300}
                  />
                );
              })}
            </View>
          </ThemedView>
        ) : null}
      </View>
    </ParallaxScrollView>
  );
}

const styles = StyleSheet.create({
  headerImageContainer: {
    width: '100%',
    height: 380,
  },
  heroImage: {
    width: '100%',
    height: '100%',
  },
  heroPlaceholder: {
    width: '100%',
    height: 380,
    backgroundColor: '#1E1E1E',
  },

  contentContainer: {
    gap: 16,
    paddingBottom: 32,
  },
  heroRow: {
    flexDirection: 'row',
    gap: 16,
    alignItems: 'flex-start',
  },
  posterImage: {
    width: 100,
    height: 150,
    borderRadius: 12,
    backgroundColor: '#2A2A2A',
  },
  heroInfo: {
    flex: 1,
    gap: 8,
    justifyContent: 'center',
  },
  titleText: {
    fontSize: 24,
    lineHeight: 28,
  },
  subtitleText: {
    fontSize: 14,
    color: '#B5B5B5',
  },
  actionRow: {
    flexDirection: 'row',
    marginTop: 8,
  },
  fab: {
    width: 44,
    height: 44,
    borderRadius: 22,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#2A2A2A',
  },
  fabActive: {
    backgroundColor: '#F5C518',
  },
  tagline: {
    color: '#E0E0E0',
    fontStyle: 'italic',
    marginTop: 4,
  },
  overview: {
    color: '#C7C7C7',
    lineHeight: 22,
    fontSize: 15,
  },
  metaRow: {
    flexDirection: 'row',
    gap: 8,
    marginTop: 8,
  },
  metaLabel: {
    fontWeight: 'bold',
    color: '#EDEDED',
  },
  metaValue: {
    color: '#C7C7C7',
    flex: 1,
  },
  sectionContainer: {
    marginTop: 24,
  },
  sectionTitle: {
    marginBottom: 12,
  },
  castScroll: {
    gap: 12,
  },
  castCard: {
    width: 100,
  },
  castImage: {
    width: 100,
    height: 100,
    borderRadius: 50, // Circular
    backgroundColor: '#2A2A2A',
    marginBottom: 8,
  },
  castName: {
    fontSize: 12,
    fontWeight: '600',
    textAlign: 'center',
  },
  castCharacter: {
    fontSize: 10,
    color: '#B5B5B5',
    textAlign: 'center',
  },
  providersSection: {
    marginTop: 24,
  },
  providersTitle: {
    marginBottom: 12,
  },
  providerRow: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 10,
  },
  providerLogo: {
    width: 44,
    height: 44,
    borderRadius: 12,
    backgroundColor: '#2A2A2A',
  },
});